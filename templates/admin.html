{% extends "base.html" %}

{% block title %}{{ translations[lang]['admin_dashboard_title'] }}{% endblock %}

{% block content %}
<div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
        <h2 class="text-3xl font-bold text-slate-900 tracking-tight">{{ translations[lang]['dashboard'] }}</h2>
        <p class="text-slate-500 mt-1">{{ translations[lang]['dashboard_subtitle'] }}</p>
    </div>
    <a href="/admin/scores"
        class="inline-flex items-center gap-2 px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
            <path fill-rule="evenodd"
                d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                clip-rule="evenodd" />
        </svg>
        {{ translations[lang]['view_edit_scores'] }}
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <div class="space-y-8">
        <!-- 1. Import Students -->
        <div
            class="bg-white rounded-2xl shadow-sm border border-slate-200/60 p-6 relative overflow-hidden group hover:shadow-md transition-all duration-300">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 text-primary-500" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            </div>

            <h4 class="flex items-center gap-3 text-lg font-bold text-slate-800 mb-4 relative z-10">
                <span
                    class="flex items-center justify-center w-8 h-8 rounded-lg bg-primary-100 text-primary-700 text-sm font-bold">1</span>
                {{ translations[lang]['import_students'] }}
            </h4>

            <form action="/admin/upload-students" method="post" enctype="multipart/form-data" class="relative z-10">
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">{{
                        translations[lang]['student_list_format'] }}</label>
                    <input
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 transition-all border border-slate-200 rounded-lg cursor-pointer bg-slate-50 focus:outline-none"
                        type="file" name="file" required>
                    <p class="mt-2 text-xs text-slate-400">{{ translations[lang]['student_format_hint'] }}</p>
                </div>
                <button type="submit"
                    class="w-full py-2.5 bg-slate-800 hover:bg-slate-900 text-white font-medium rounded-xl shadow-sm hover:shadow transition-all active:scale-[0.98]">
                    {{ translations[lang]['upload_students_btn'] }}
                </button>
            </form>
        </div>

        <!-- 2. Upload Grades -->
        <div
            class="bg-white rounded-2xl shadow-sm border border-slate-200/60 p-6 relative overflow-hidden group hover:shadow-md transition-all duration-300">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 text-indigo-500" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>

            <h4 class="flex items-center gap-3 text-lg font-bold text-slate-800 mb-4 relative z-10">
                <span
                    class="flex items-center justify-center w-8 h-8 rounded-lg bg-indigo-100 text-indigo-700 text-sm font-bold">2</span>
                {{ translations[lang]['upload_grades_title'] }}
            </h4>

            <form action="/admin/upload-grades" method="post" enctype="multipart/form-data" class="relative z-10">
                <div class="mb-4">
                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">{{
                        translations[lang]['excel_files'] }}</label>
                    <input
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-all border border-slate-200 rounded-lg cursor-pointer bg-slate-50 focus:outline-none"
                        type="file" name="files" multiple required>
                    <p class="mt-2 text-xs text-slate-400">{{ translations[lang]['upload_grades_hint'] }}</p>
                </div>
                <button type="submit"
                    class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-xl shadow-md hover:shadow-lg transition-all active:scale-[0.98]">
                    {{ translations[lang]['upload_process_btn'] }}
                </button>
            </form>
        </div>
    </div>

    <!-- Right Column -->
    <div class="space-y-8">
        <!-- Exam Management -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200/60 p-6">
            <h4 class="text-lg font-bold text-slate-800 mb-2">{{ translations[lang]['exam_management'] }}</h4>

            <!-- Create Exam Manual -->
            <form action="/admin/exams/create" method="post" class="mb-6 flex gap-2">
                <input type="text" name="exam_name" placeholder="{{ translations[lang]['new_exam_name'] }}" required
                    class="flex-1 px-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                <button type="submit"
                    class="px-4 py-2 bg-slate-800 text-white text-sm font-medium rounded-lg hover:bg-slate-900 transition-colors">
                    {{ translations[lang]['add_exam'] }}
                </button>
            </form>

            <p class="text-sm text-slate-500 mb-4 border-l-4 border-indigo-500 pl-3 bg-indigo-50/50 py-2 rounded-r-lg">
                {{ translations[lang]['open_submission_hint'] | safe }}
            </p>

            <div class="overflow-x-auto rounded-xl border border-slate-200 mb-4">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider">
                        <tr>
                            <th class="px-5 py-3 border-b border-slate-200">{{ translations[lang]['exam_name'] }}</th>
                            <th class="px-5 py-3 border-b border-slate-200 text-center">{{
                                translations[lang]['mandatory_th'] }}</th>
                            <th class="px-5 py-3 border-b border-slate-200 text-center">{{
                                translations[lang]['submission_th'] }}</th>
                            <th class="px-5 py-3 border-b border-slate-200 text-right">{{
                                translations[lang]['actions_th'] }}</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for exam in exams %}
                        <tr class="hover:bg-slate-50/80 transition-colors">
                            <td class="px-5 py-3 text-sm font-medium text-slate-700">{{ exam.name }}</td>

                            <!-- Mandatory Toggle (Global Form needed for valid state?) -> Actually better to have individual toggles or one form. 
                                 Previous design was bulk update. Let's keep bulk update for Mandatory, OR switch to individual endpoints.
                                 Let's stick to the BULK update logic for Mandatory for now to avoid breaking existing flow, 
                                 BUT simpler UI: Just show Checkbox inside a master form? 
                                 OR Separate actions. 
                                 Let's keep the Form wrap for Mandatory, but injecting other buttons inside is messy.
                                 Better: Row-based actions.
                            -->
                            <td class="px-5 py-3 text-center">
                                <!-- Hack: Using a separate small form or just display status? 
                                     The user wants to MANAGE exams. 
                                     Let's make Mandatory part of the bulk update at the bottom, 
                                     and others as individual actions.
                                -->
                                <input form="config-form" type="checkbox" name="mandatory_exams" value="{{ exam.id }}"
                                    class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300" {% if
                                    exam.is_mandatory %}checked{% endif %}>
                            </td>

                            <td class="px-5 py-3 text-center">
                                <form action="/admin/exams/toggle-submission" method="post" class="inline">
                                    <input type="hidden" name="exam_id" value="{{ exam.id }}">
                                    <input type="hidden" name="is_open"
                                        value="{% if exam.is_open_for_submission %}0{% else %}1{% endif %}">
                                    <button type="submit"
                                        class="px-3 py-1 text-xs font-bold rounded-full transition-colors {% if exam.is_open_for_submission %}bg-green-100 text-green-700 hover:bg-green-200{% else %}bg-slate-100 text-slate-500 hover:bg-slate-200{% endif %}">
                                        {% if exam.is_open_for_submission %}{{ translations[lang]['open_status'] }}{%
                                        else %}{{ translations[lang]['closed_status'] }}{% endif %}
                                    </button>
                                </form>
                            </td>

                            <td class="px-5 py-3 text-right">
                                <form action="/admin/exams/delete" method="post" class="inline"
                                    onsubmit="return confirm('{{ translations[lang]['delete_confirm'].format(exam.name) | replace("'", "\\'") }}');">
                                    <input type="hidden" name="exam_id" value="{{ exam.id }}">
                                    <button type="submit" class="text-red-500 hover:text-red-700 p-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not exams %}
                        <tr>
                            <td colspan="4" class="px-5 py-4 text-center text-sm text-slate-400 italic">{{
                                translations[lang]['no_exams'] }}
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <form id="config-form" action="/admin/update-exams" method="post">
                <button type="submit"
                    class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-xl shadow-md transition-all active:scale-[0.98]">
                    {{ translations[lang]['save_mandatory'] }}
                </button>
            </form>
        </div>

        <!-- Database Management -->
        <div class="bg-white rounded-2xl shadow-sm border border-red-100 p-0 overflow-hidden">
            <div class="bg-red-50/50 p-4 border-b border-red-100 flex items-center gap-3">
                <div class="p-2 bg-red-100 text-red-600 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <h4 class="font-bold text-red-800">{{ translations[lang]['database_management'] }}</h4>
            </div>

            <div class="p-6 space-y-6">
                <!-- Export -->
                <div>
                    <h6 class="text-sm font-bold text-slate-800 mb-2">{{ translations[lang]['export_data'] }}</h6>
                    <div class="grid grid-cols-2 gap-3">
                        <a href="/admin/export-json"
                            class="flex flex-col items-center justify-center p-3 border border-slate-200 hover:border-slate-300 hover:bg-slate-50 rounded-xl transition-all text-center">
                            <span class="text-xs font-bold text-slate-700">{{ translations[lang]['backup_json']
                                }}</span>
                            <span class="text-[10px] text-slate-400">{{ translations[lang]['full_db_dump'] }}</span>
                        </a>
                        <a href="/admin/export-grades-excel"
                            class="flex flex-col items-center justify-center p-3 border border-green-200 bg-green-50/30 hover:bg-green-50 hover:border-green-300 rounded-xl transition-all text-center">
                            <span class="text-xs font-bold text-green-700">{{ translations[lang]['grades_excel']
                                }}</span>
                            <span class="text-[10px] text-green-600/70">{{ translations[lang]['xlsx_report'] }}</span>
                        </a>
                    </div>
                </div>

                <div class="h-px bg-slate-100"></div>

                <!-- Import -->
                <div>
                    <h6 class="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2">
                        {{ translations[lang]['import_data'] }}
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-600">{{
                            translations[lang]['destructive'] }}</span>
                    </h6>
                    <form action="/admin/import-json" method="post" enctype="multipart/form-data">
                        <div class="flex gap-2">
                            <input
                                class="block w-full text-xs text-slate-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 border border-slate-200 rounded-lg cursor-pointer bg-slate-50"
                                type="file" name="file" accept=".json" required>
                            <button type="submit"
                                onclick="return confirm('{{ translations[lang]['import_confirm'] | replace("'", "\\'") }}');"
                                class="px-4 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-lg shadow-sm whitespace-nowrap transition-colors">
                                {{ translations[lang]['restore'] }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}