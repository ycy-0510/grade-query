{% extends "base.html" %}

{% block title %}{{ translations[lang]['admin_dashboard_title'] }}{% endblock %}

{% block content %}
<div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
        <h2 class="text-3xl font-bold text-slate-900 tracking-tight">{{ translations[lang]['dashboard'] }}</h2>
        <p class="text-slate-500 mt-1">{{ translations[lang]['dashboard_subtitle'] }}</p>
    </div>
    <div class="flex flex-wrap gap-3">
        <!-- Send Grades Email Button -->
        <button type="button" onclick="openEmailModal()"
            class="inline-flex items-center gap-2 px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-sm hover:shadow-md transition-all active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
            </svg>
            {{ translations[lang]['send_email_btn'] }}
        </button>

        <!-- New Upload Data Button -->
        <button type="button" onclick="openUploadModal()"
            class="inline-flex items-center gap-2 px-5 py-2.5 bg-white border border-slate-200 text-slate-700 font-medium rounded-lg shadow-sm hover:bg-slate-50 transition-all active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
            {{ translations[lang]['upload_data_btn'] }}
        </button>

        <a href="/admin/logs"
            class="inline-flex items-center gap-2 px-5 py-2.5 bg-white border border-slate-200 text-slate-700 font-medium rounded-lg shadow-sm hover:bg-slate-50 transition-all active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
            </svg>
            {{ translations[lang]['view_logs'] }}
        </a>
        <a href="/admin/login-logs"
            class="inline-flex items-center gap-2 px-5 py-2.5 bg-white border border-slate-200 text-slate-700 font-medium rounded-lg shadow-sm hover:bg-slate-50 transition-all active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            {{ translations[lang]['login_logs_nav'] }}
        </a>
        <a href="/admin/scores"
            class="inline-flex items-center gap-2 px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all active:scale-95">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                <path fill-rule="evenodd"
                    d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"
                    clip-rule="evenodd" />
            </svg>
            {{ translations[lang]['view_edit_scores'] }}
        </a>
    </div>
</div>

<div class="w-full max-w-5xl mx-auto space-y-8">
    <!-- Main Column -->
    <div class="space-y-8">
        <!-- Exam Management -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200/60 p-6">
            <h4 class="text-lg font-bold text-slate-800 mb-2">{{ translations[lang]['exam_management'] }}</h4>

            <!-- Create Exam Manual -->
            <form action="/admin/exams/create" method="post" class="mb-6 flex gap-2">
                <input type="hidden" name="csrf_token" value="{{ request.session.csrf_token }}">
                <input type="text" name="exam_name" placeholder="{{ translations[lang]['new_exam_name'] }}" required
                    class="flex-1 px-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                <button type="submit"
                    class="px-4 py-2 bg-slate-800 text-white text-sm font-medium rounded-lg hover:bg-slate-900 transition-colors">
                    {{ translations[lang]['add_exam'] }}
                </button>
            </form>

            <p class="text-sm text-slate-500 mb-4 border-l-4 border-indigo-500 pl-3 bg-indigo-50/50 py-2 rounded-r-lg">
                {{ translations[lang]['open_submission_hint'] | safe }}
            </p>

            <div class="overflow-x-auto rounded-xl border border-slate-200 mb-4">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold tracking-wider">
                        <tr>
                            <th class="px-5 py-3 border-b border-slate-200">{{ translations[lang]['exam_name'] }}</th>
                            <th class="px-5 py-3 border-b border-slate-200 text-center">{{
                                translations[lang]['mandatory_th'] }}</th>
                            <th class="px-5 py-3 border-b border-slate-200 text-center">{{
                                translations[lang]['submission_th'] }}</th>
                            <th class="px-5 py-3 border-b border-slate-200 text-right">{{
                                translations[lang]['actions_th'] }}</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for exam in exams %}
                        <tr class="hover:bg-slate-50/80 transition-colors">
                            <td class="px-5 py-3 text-sm font-medium text-slate-700">{{ exam.name }}</td>
                            <td class="px-5 py-3 text-center">
                                <input form="config-form" type="checkbox" name="mandatory_exams" value="{{ exam.id }}"
                                    class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300" {% if
                                    exam.is_mandatory %}checked{% endif %}>
                            </td>

                            <td class="px-5 py-3 text-center">
                                {% set is_expired = False %}
                                {% if exam.submission_deadline and exam.submission_deadline < now_utc %} {% set
                                    is_expired=True %} {% endif %} <button type="button"
                                    onclick="openEditStatusModal(this)" data-exam-id="{{ exam.id }}"
                                    data-exam-name="{{ exam.name }}"
                                    data-is-open="{{ 'true' if exam.is_open_for_submission else 'false' }}"
                                    data-deadline="{{ exam.submission_deadline.isoformat() if exam.submission_deadline else '' }}"
                                    id="status-pill-{{ exam.id }}" class="px-3 py-1 text-xs font-bold rounded-full transition-colors 
                                    {% if not exam.is_open_for_submission %}
                                        bg-slate-100 text-slate-500 hover:bg-slate-200
                                    {% elif is_expired %}
                                        bg-red-100 text-red-700 hover:bg-red-200
                                    {% elif exam.submission_deadline %}
                                        bg-blue-100 text-blue-700 hover:bg-blue-200
                                    {% else %}
                                        bg-green-100 text-green-700 hover:bg-green-200
                                    {% endif %}">

                                    {% if not exam.is_open_for_submission %}
                                    {{ translations[lang]['closed_status'] }}
                                    {% elif is_expired %}
                                    {{ translations[lang]['expired'] }}
                                    {% elif exam.submission_deadline %}
                                    {{ translations[lang]['open_until'] }}...
                                    {% else %}
                                    {{ translations[lang]['open_status'] }}
                                    {% endif %}
                                    </button>
                            </td>

                            <td class="px-5 py-3 text-right">
                                <form action="/admin/exams/delete" method="post" class="inline"
                                    onsubmit="return confirm('{{ translations[lang]['delete_confirm'].format(exam.name) | replace('\'', '\\\'') }}');">
                                    <input type="hidden" name="csrf_token" value="{{ request.session.csrf_token }}">
                                    <input type="hidden" name="exam_id" value="{{ exam.id }}">
                                    <button type="submit" class="text-red-500 hover:text-red-700 p-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                            fill="currentColor">
                                            <path fill-rule="evenodd"
                                                d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not exams %}
                        <tr>
                            <td colspan="5" class="px-5 py-4 text-center text-sm text-slate-400 italic">{{
                                translations[lang]['no_exams'] }}
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <form id="config-form" action="/admin/update-exams" method="post">
                <input type="hidden" name="csrf_token" value="{{ request.session.csrf_token }}">
                <button type="submit"
                    class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-xl shadow-md transition-all active:scale-[0.98]">
                    {{ translations[lang]['save_mandatory'] }}
                </button>
            </form>
        </div>

        <!-- Database Management -->
        <div class="bg-white rounded-2xl shadow-sm border border-red-100 p-0 overflow-hidden">
            <div class="bg-red-50/50 p-4 border-b border-red-100 flex items-center gap-3">
                <div class="p-2 bg-red-100 text-red-600 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <h4 class="font-bold text-red-800">{{ translations[lang]['database_management'] }}</h4>
            </div>

            <div class="p-6 space-y-6">
                <!-- Export -->
                <div>
                    <h6 class="text-sm font-bold text-slate-800 mb-2">{{ translations[lang]['export_data'] }}</h6>
                    <div class="grid grid-cols-2 gap-3">
                        <a href="/admin/export-json"
                            class="flex flex-col items-center justify-center p-3 border border-slate-200 hover:border-slate-300 hover:bg-slate-50 rounded-xl transition-all text-center">
                            <span class="text-xs font-bold text-slate-700">{{ translations[lang]['backup_json']
                                }}</span>
                            <span class="text-[10px] text-slate-400">{{ translations[lang]['full_db_dump'] }}</span>
                        </a>
                        <a href="/admin/export-grades-excel"
                            class="flex flex-col items-center justify-center p-3 border border-green-200 bg-green-50/30 hover:bg-green-50 hover:border-green-300 rounded-xl transition-all text-center">
                            <span class="text-xs font-bold text-green-700">{{ translations[lang]['grades_excel']
                                }}</span>
                            <span class="text-[10px] text-green-600/70">{{ translations[lang]['xlsx_report'] }}</span>
                        </a>
                    </div>
                </div>

                <div class="h-px bg-slate-100"></div>

                <!-- Import -->
                <div>
                    <h6 class="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2">
                        {{ translations[lang]['import_data'] }}
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-600">{{
                            translations[lang]['destructive'] }}</span>
                    </h6>
                    <form action="/admin/import-json" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ request.session.csrf_token }}">
                        <div class="flex gap-2">
                            <input
                                class="block w-full text-xs text-slate-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 border border-slate-200 rounded-lg cursor-pointer bg-slate-50"
                                type="file" name="file" accept=".json" required>
                            <button type="submit"
                                onclick="return confirm('{{ translations[lang]['import_confirm'] | replace('\'', '\\\'') }}');"
                                class="px-4 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-lg shadow-sm whitespace-nowrap transition-colors">
                                {{ translations[lang]['restore'] }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

</div>


<!-- SEND EMAIL MODAL -->
<div id="emailModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeEmailModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-blue-600 px-4 py-3 sm:px-6 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">
                    {{ translations[lang]['send_email_title'] }}
                </h3>
                <button type="button" onclick="closeEmailModal()" class="text-blue-200 hover:text-white focus:outline-none">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="px-4 py-5 sm:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Left: Student List -->
                <div class="md:col-span-1 border-r border-slate-200 pr-4">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-bold text-slate-700">{{ translations[lang]['students'] }}</h4>
                        <div class="space-x-1 text-xs">
                            <button onclick="toggleAllStudents(true)" class="text-blue-600 hover:underline">All</button>
                            <span>/</span>
                            <button onclick="toggleAllStudents(false)" class="text-slate-500 hover:underline">None</button>
                        </div>
                    </div>
                    <div id="student-list-container" class="h-80 overflow-y-auto border border-slate-200 rounded-lg p-2 bg-slate-50">
                        <div class="text-center text-slate-400 py-10">Loading...</div>
                    </div>
                    <div class="mt-2 text-xs text-slate-500">
                        Selected: <span id="selected-count" class="font-bold text-slate-800">0</span>
                    </div>
                </div>

                <!-- Right: Email Content -->
                <div class="md:col-span-2 flex flex-col h-full">
                    <div class="space-y-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ translations[lang]['subject'] }}</label>
                            <input type="text" id="email-subject" value="{{ translations[lang]['default_email_subject'] }}"
                                class="w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">{{ translations[lang]['body'] }}</label>
                            <textarea id="email-body" rows="6"
                                class="w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500 font-mono">{{ translations[lang]['default_email_body'] }}</textarea>
                            <p class="mt-1 text-xs text-slate-400">Available variables: {{ '{{name}}' }}</p>
                        </div>
                    </div>

                    <!-- Progress Log -->
                    <div id="progress-container" class="hidden flex-1 border border-slate-200 rounded-lg bg-slate-900 text-green-400 font-mono text-xs p-3 overflow-y-auto h-32 mb-4">
                    </div>

                    <div class="mt-auto flex justify-end gap-3">
                         <button type="button" onclick="closeEmailModal()"
                            class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            {{ translations[lang]['cancel'] }}
                        </button>
                        <button type="button" onclick="sendEmails()" id="send-btn"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            {{ translations[lang]['send'] }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Upload Modal Logic ---
    function openUploadModal() {
        document.getElementById('uploadModal').classList.remove('hidden');
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').classList.add('hidden');
    }

    // --- Email Modal Logic ---
    let studentsLoaded = false;
    let studentsData = [];

    function openEmailModal() {
        document.getElementById('emailModal').classList.remove('hidden');
        if (!studentsLoaded) {
            fetchStudents();
        }

        // Reset Progress
        document.getElementById('progress-container').classList.add('hidden');
        document.getElementById('progress-container').innerHTML = '';
        document.getElementById('send-btn').disabled = false;

        // Check URL for auth success
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('email_auth') === 'success') {
            // Maybe show a toast?
            // Remove param
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }

    function closeEmailModal() {
        document.getElementById('emailModal').classList.add('hidden');
    }

    async function fetchStudents() {
        try {
            const res = await fetch('/admin/api/students');
            if (!res.ok) throw new Error("Failed to load");
            studentsData = await res.json();
            renderStudents();
            studentsLoaded = true;
        } catch (e) {
            document.getElementById('student-list-container').innerHTML = '<div class="text-red-500 text-center text-sm">Error loading students</div>';
        }
    }

    function renderStudents() {
        const container = document.getElementById('student-list-container');
        if (studentsData.length === 0) {
            container.innerHTML = '<div class="text-slate-400 text-center text-sm p-4">No students found</div>';
            return;
        }

        let html = '';
        studentsData.forEach(s => {
            html += `
            <div class="flex items-center gap-2 py-1.5 px-2 hover:bg-slate-100 rounded">
                <input type="checkbox" value="${s.id}" class="student-checkbox w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" onchange="updateSelectedCount()" checked>
                <div class="min-w-0">
                    <div class="text-sm font-medium text-slate-800 truncate">${s.name}</div>
                    <div class="text-xs text-slate-500 truncate">${s.seat_number} - ${s.email}</div>
                </div>
            </div>
            `;
        });
        container.innerHTML = html;
        updateSelectedCount();
    }

    function toggleAllStudents(checked) {
        document.querySelectorAll('.student-checkbox').forEach(cb => cb.checked = checked);
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = document.querySelectorAll('.student-checkbox:checked').length;
        document.getElementById('selected-count').innerText = count;
    }

    async function sendEmails() {
        const checkboxes = document.querySelectorAll('.student-checkbox:checked');
        const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
        const subject = document.getElementById('email-subject').value;
        const body = document.getElementById('email-body').value;
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;

        if (ids.length === 0) {
            alert("Please select at least one student.");
            return;
        }

        const btn = document.getElementById('send-btn');
        btn.disabled = true;

        const progressContainer = document.getElementById('progress-container');
        progressContainer.classList.remove('hidden');
        progressContainer.innerHTML = '<div>Initiating...</div>';

        try {
            const res = await fetch('/admin/api/send-grades', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({
                    student_ids: ids,
                    subject: subject,
                    body: body
                })
            });

            if (res.status === 403) {
                // Auth required
                // Try to parse json to see if it is auth_required
                try {
                    const data = await res.json();
                    if (data.error === 'auth_required') {
                         if (confirm("Gmail permission is required to send emails. Click OK to authorize.")) {
                             // Redirect to auth
                             window.location.href = "/admin/auth/gmail";
                         } else {
                             btn.disabled = false;
                         }
                         return;
                    }
                } catch(e) {}

                alert("Unauthorized or Permission Missing");
                btn.disabled = false;
                return;
            }

            if (!res.ok) {
                throw new Error("Server Error");
            }

            // Read Stream
            const reader = res.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const dataStr = line.replace('data: ', '').trim();
                        if (dataStr === 'close') break;

                        try {
                            const data = JSON.parse(dataStr);
                            const logLine = document.createElement('div');
                            if (data.status === 'sent') {
                                logLine.className = 'text-green-400';
                                logLine.textContent = `[SUCCESS] ${data.name}: Sent`;
                            } else {
                                logLine.className = 'text-red-400';
                                logLine.textContent = `[FAILED] ${data.name || data.student_id}: ${data.error}`;
                            }
                            progressContainer.appendChild(logLine);
                            progressContainer.scrollTop = progressContainer.scrollHeight;
                        } catch(e) {}
                    }
                }
            }

            const doneLine = document.createElement('div');
            doneLine.className = 'text-white font-bold mt-2';
            doneLine.textContent = '--- Finished ---';
            progressContainer.appendChild(doneLine);
            progressContainer.scrollTop = progressContainer.scrollHeight;

        } catch (e) {
            console.error(e);
            progressContainer.innerHTML += `<div class="text-red-500 font-bold">Error: ${e.message}</div>`;
        } finally {
            btn.disabled = false;
        }
    }

</script>


<!-- Edit Status Modal -->
<div id="statusModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeStatusModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">
                            {{ translations[lang]['set_deadline'] }} <!-- Reuse key or use edit_status -->
                        </h3>
                        <div class="mt-2 text-sm text-gray-500" id="modal-exam-name">Exam Name</div>

                        <div class="mt-4 space-y-4">
                            <!-- Toggle switch -->
                            <div class="flex items-center justify-between">
                                <label class="text-sm font-medium text-gray-700">{{ translations[lang]['open_status']
                                    }}</label>
                                <button type="button" id="toggle-btn"
                                    class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 bg-gray-200"
                                    role="switch" aria-checked="false" onclick="toggleSwitch()">
                                    <span aria-hidden="true" id="toggle-circle"
                                        class="translate-x-0 pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                                </button>
                            </div>

                            <!-- Deadline Input -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">{{
                                    translations[lang]['deadline'] }}</label>
                                <div class="flex gap-2">
                                    <input type="datetime-local" id="modal-deadline-input"
                                        class="flex-1 border border-gray-300 rounded-md shadow-sm px-3 py-2 text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <button type="button"
                                        onclick="document.getElementById('modal-deadline-input').value = ''"
                                        class="px-3 py-2 border border-slate-200 rounded-md text-slate-500 hover:bg-slate-50 text-xs font-bold">
                                        {{ translations[lang]['clear_deadline'] }}
                                    </button>
                                </div>
                            </div>

                            <div class="flex flex-row-reverse gap-2 mt-6">
                                <button type="button" onclick="saveStatus()"
                                    class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">
                                    {{ translations[lang]['save_changes_btn'] }}
                                </button>
                                <button type="button" onclick="closeStatusModal()"
                                    class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">
                                    {{ translations[lang]['cancel'] }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Data Modal -->
<div id="uploadModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeUploadModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                    {{ translations[lang]['upload_data_btn'] }}
                </h3>
                <button type="button" onclick="closeUploadModal()"
                    class="text-gray-400 hover:text-gray-500 focus:outline-none">
                    <span class="sr-only">Close</span>
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="px-4 py-5 sm:p-6 space-y-8">
                <!-- 1. Import Students -->
                <div>
                    <h4 class="flex items-center gap-3 text-base font-bold text-slate-800 mb-4">
                        <span
                            class="flex items-center justify-center w-8 h-8 rounded-lg bg-primary-100 text-primary-700 text-sm font-bold">1</span>
                        {{ translations[lang]['import_students'] }}
                    </h4>
                    <form action="/admin/upload-students" method="post" enctype="multipart/form-data"
                        class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <input type="hidden" name="csrf_token" value="{{ request.session.csrf_token }}">
                        <div class="mb-4">
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">{{
                                translations[lang]['student_list_format'] }}</label>
                            <input
                                class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 transition-all border border-slate-200 rounded-lg cursor-pointer bg-white focus:outline-none"
                                type="file" name="file" required>
                            <p class="mt-2 text-xs text-slate-400">{{ translations[lang]['student_format_hint'] }}</p>
                        </div>
                        <button type="submit"
                            class="w-full py-2.5 bg-slate-800 hover:bg-slate-900 text-white font-medium rounded-xl shadow-sm hover:shadow transition-all active:scale-[0.98]">
                            {{ translations[lang]['upload_students_btn'] }}
                        </button>
                    </form>
                </div>

                <div class="border-t border-slate-200"></div>

                <!-- 2. Upload Grades -->
                <div>
                    <h4 class="flex items-center gap-3 text-base font-bold text-slate-800 mb-4">
                        <span
                            class="flex items-center justify-center w-8 h-8 rounded-lg bg-indigo-100 text-indigo-700 text-sm font-bold">2</span>
                        {{ translations[lang]['upload_grades_title'] }}
                    </h4>

                    <form action="/admin/upload-grades" method="post" enctype="multipart/form-data"
                        class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <input type="hidden" name="csrf_token" value="{{ request.session.csrf_token }}">
                        <div class="mb-4">
                            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">{{
                                translations[lang]['excel_files'] }}</label>
                            <input
                                class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-all border border-slate-200 rounded-lg cursor-pointer bg-white focus:outline-none"
                                type="file" name="files" multiple required>
                            <p class="mt-2 text-xs text-slate-400">{{ translations[lang]['upload_grades_hint'] }}</p>
                        </div>
                        <button type="submit"
                            class="w-full py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-xl shadow-md hover:shadow-lg transition-all active:scale-[0.98]">
                            {{ translations[lang]['upload_process_btn'] }}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentExamId = null;
    let isToggledOn = false;

    // Helper to format Date for input
    function toLocalIso(utcIso) {
        if (!utcIso) return "";
        let isoStr = utcIso;
        if (!isoStr.endsWith('Z')) isoStr += 'Z';
        const date = new Date(isoStr);
        const offsetMs = date.getTimezoneOffset() * 60000;
        const localDate = new Date(date.getTime() - offsetMs);
        return localDate.toISOString().slice(0, 16);
    }

    function toggleSwitch() {
        isToggledOn = !isToggledOn;
        updateSwitchUI();
    }

    function updateSwitchUI() {
        const btn = document.getElementById('toggle-btn');
        const circle = document.getElementById('toggle-circle');
        if (isToggledOn) {
            btn.classList.remove('bg-gray-200');
            btn.classList.add('bg-green-500');
            circle.classList.remove('translate-x-0');
            circle.classList.add('translate-x-5');
        } else {
            btn.classList.add('bg-gray-200');
            btn.classList.remove('bg-green-500');
            circle.classList.add('translate-x-0');
            circle.classList.remove('translate-x-5');
        }
    }

    function openEditStatusModal(btn) {
        currentExamId = btn.dataset.examId;
        const examName = btn.dataset.examName;
        const isOpen = btn.dataset.isOpen === 'true';
        const utcDeadline = btn.dataset.deadline;

        document.getElementById('modal-exam-name').textContent = examName;

        // Set Toggle
        isToggledOn = isOpen;
        updateSwitchUI();

        // Set Deadline
        document.getElementById('modal-deadline-input').value = toLocalIso(utcDeadline);

        document.getElementById('statusModal').classList.remove('hidden');
    }

    function closeStatusModal() {
        document.getElementById('statusModal').classList.add('hidden');
    }

    async function saveStatus() {
        const deadlineVal = document.getElementById('modal-deadline-input').value;
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        const offset = new Date().getTimezoneOffset(); // minutes. e.g. -480

        const payload = {
            exam_id: parseInt(currentExamId),
            is_open: isToggledOn,
            deadline: deadlineVal ? deadlineVal : null,
            timezone_offset: offset
        };

        try {
            const res = await fetch('/admin/api/exams/update-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                const data = await res.json();
                updatePill(data);
                closeStatusModal();
            } else {
                alert('Error updating status');
            }
        } catch (e) {
            console.error(e);
            alert('Error updating status');
        }
    }

    function updatePill(data) {
        const btn = document.getElementById('status-pill-' + data.exam_id);
        if (!btn) return;

        // Update data attributes
        btn.dataset.isOpen = data.is_open ? 'true' : 'false';
        btn.dataset.deadline = data.deadline ? data.deadline : '';

        // Logic for formatting
        // We need 'is_deadline_passed' logic in JS or from server? 
        // Server returned 'is_effectively_open'. But visual display distinguishes 'expired'.

        // Let's use JS logic to be snappy
        const now = new Date();

        let isExpired = false;
        if (data.deadline) {
            // Python ISO string might not have Z. "2023-01-01T10:00:00"
            // Interpretation depends on browser if no Z.
            // Best to treat as UTC. appending Z if missing in JS side.
            let dStr = data.deadline;
            if (!dStr.endsWith('Z')) dStr += 'Z';
            if (new Date(dStr) < now) isExpired = true;
        }

        let text = "";
        let classes = "px-3 py-1 text-xs font-bold rounded-full transition-colors ";

        if (!data.is_open) {
            classes += "bg-slate-100 text-slate-500 hover:bg-slate-200";
            text = "{{ translations[lang]['closed_status'] }}";
        } else if (isExpired) {
            classes += "bg-red-100 text-red-700 hover:bg-red-200";
            text = "{{ translations[lang]['expired'] }}";
        } else if (data.deadline) {
            classes += "bg-blue-100 text-blue-700 hover:bg-blue-200";
            text = "{{ translations[lang]['open_until'] }}...";
        } else {
            classes += "bg-green-100 text-green-700 hover:bg-green-200";
            text = "{{ translations[lang]['open_status'] }}";
        }

        btn.className = classes;
        btn.textContent = text;
    }
</script>
{% endblock %}